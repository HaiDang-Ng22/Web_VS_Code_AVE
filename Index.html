<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeRunner - Trình xem code trực tuyến</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* Reset và Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #007acc;
            --primary-dark: #005a9e;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --dark-bg: #1e1e1e;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --text-light: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius: 10px;
            --radius-sm: 6px;
            --transition: all 0.3s ease;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
        }
        
        .loading-overlay .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-overlay p {
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Auth Container */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-box {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            position: relative;
            overflow: hidden;
        }

        .auth-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary-color), var(--info-color));
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2rem;
            font-weight: 700;
        }

        .auth-header p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .auth-form .form-group {
            margin-bottom: 20px;
        }

        .auth-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .auth-form input {
            width: 100%;
            padding: 14px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background-color: #f8f9fa;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
            background-color: white;
        }

        /* Buttons */
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.2);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #333;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 0.9rem;
        }

        .btn-lg {
            padding: 16px 24px;
            font-size: 1.1rem;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            font-size: 0.9rem;
            border-left: 4px solid var(--danger-color);
        }

        /* Main Container */
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(0, 122, 204, 0.3);
        }

        .user-name {
            font-weight: 600;
            color: var(--text-color);
        }

        /* Admin Dashboard */
        .admin-dashboard {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Admin Sidebar */
        .admin-sidebar {
            width: 320px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
        }

        .admin-sidebar-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-sidebar-header h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .code-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .code-item {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .code-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.1);
            transform: translateY(-2px);
        }

        .code-item.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 122, 204, 0.05);
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.15);
        }

        .code-item.selected::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: var(--primary-color);
            border-radius: var(--radius) 0 0 var(--radius);
        }

        .code-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .code-item-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-color);
            flex: 1;
        }

        .code-item-actions {
            display: flex;
            gap: 5px;
        }

        .code-item-language {
            display: inline-block;
            background-color: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .code-item-language.html { background-color: #e34f26; color: white; }
        .code-item-language.css { background-color: #1572b6; color: white; }
        .code-item-language.javascript { background-color: #f7df1e; color: #333; }

        .code-item-date {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Admin Content */
        .admin-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--light-bg);
        }

        .admin-toolbar {
            padding: 20px 25px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-toolbar h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .admin-toolbar-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            min-height: 500px;
        }

        .code-editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 300px;
            background-color: var(--card-bg);
        }

        .editor-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-header h3 {
            color: var(--text-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        #code-editor {
            flex: 1;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            border: none;
            outline: none;
            resize: none;
            background-color: #f8f9fa;
            color: #333;
            min-height: 300px;
        }

        /* Resizable handle */
        .resize-handle {
            width: 8px;
            background-color: var(--border-color);
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .resize-handle:hover {
            background-color: var(--primary-color);
        }

        .resize-handle::after {
            content: '';
            width: 2px;
            height: 30px;
            background-color: #adb5bd;
            border-radius: 1px;
        }

        /* Preview Section */
        .preview-section {
            flex: 3;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--card-bg);
        }

        .preview-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h3 {
            color: var(--text-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-content {
            flex: 1;
            overflow: hidden;
            background-color: white;
        }

        #preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }

        /* User View - FULL SCREEN */
        .user-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            z-index: 1000;
            overflow: hidden;
        }

        .user-view-content {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Mini control bar for user */
        .user-mini-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0.3;
            transition: opacity 0.3s;
        }

        .user-mini-controls:hover {
            opacity: 1;
        }

        .user-mini-controls .user-info-mini {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 0.9rem;
        }

        .user-mini-controls .user-avatar-mini {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Fullscreen exit button */
        .fullscreen-exit-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            opacity: 0.5;
        }

        .fullscreen-exit-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background-color: rgba(220, 53, 69, 1);
        }

        /* Code info overlay */
        .code-info-overlay {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            max-width: 300px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .code-info-overlay:hover {
            opacity: 1;
        }

        .code-info-overlay h4 {
            margin: 0 0 5px 0;
            color: #4dabf7;
            font-size: 1rem;
        }

        .code-info-overlay p {
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Fullscreen iframe */
        .user-preview-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .user-preview-frame-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #user-preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary-color), var(--info-color));
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-header h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-footer {
            margin-top: 25px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 6px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 20px;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            min-width: 300px;
            border-left: 4px solid var(--primary-color);
        }
        
        .notification.success {
            border-left-color: var(--success-color);
        }
        
        .notification.error {
            border-left-color: var(--danger-color);
        }
        
        .notification.info {
            border-left-color: var(--info-color);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            margin-left: 15px;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .notification-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Database Error Modal */
        .db-error-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .db-error-content {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 40px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .db-error-icon {
            font-size: 4rem;
            color: var(--danger-color);
            margin-bottom: 20px;
        }

        .db-error-content h2 {
            color: var(--danger-color);
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .db-error-content p {
            margin-bottom: 20px;
            line-height: 1.6;
            color: var(--text-light);
        }

        .db-error-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .offline-mode {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }

        .offline-mode h4 {
            color: var(--warning-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .admin-sidebar {
                width: 280px;
            }
        }

        @media (max-width: 1024px) {
            .admin-dashboard {
                flex-direction: column;
            }
            
            .admin-sidebar {
                width: 100%;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .editor-container {
                flex-direction: column;
            }
            
            .code-editor-section {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                min-height: 300px;
            }
            
            .resize-handle {
                width: 100%;
                height: 8px;
                cursor: row-resize;
            }
            
            .resize-handle::after {
                width: 30px;
                height: 2px;
            }
        }

        @media (max-width: 768px) {
            .auth-box {
                padding: 30px 20px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .admin-toolbar {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .admin-toolbar-actions {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .editor-actions {
                flex-wrap: wrap;
            }
            
            .modal-content {
                padding: 25px 20px;
            }
            
            .db-error-content {
                padding: 30px 20px;
            }
        }

        @media (max-width: 480px) {
            .auth-box {
                padding: 25px 15px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .modal-content {
                padding: 20px 15px;
            }
            
            .db-error-actions {
                flex-direction: column;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text">Đang khởi tạo ứng dụng...</p>
    </div>

    <!-- Database Error Modal -->
    <div id="db-error-modal" class="db-error-modal hidden">
        <div class="db-error-content">
            <div class="db-error-icon">
                <i class="fas fa-database"></i>
            </div>
            <h2>Lỗi kết nối Database</h2>
            <p>Không thể kết nối đến Firebase Database. Vui lòng kiểm tra:</p>
            
            <div class="offline-mode">
                <h4><i class="fas fa-info-circle"></i> Thông tin</h4>
                <p>Ứng dụng cần kết nối Firebase để hoạt động. Có thể có các nguyên nhân sau:</p>
                <ul style="text-align: left; padding-left: 20px; margin-top: 10px;">
                    <li>Không có kết nối Internet</li>
                    <li>Firebase Database Rules chưa được cấu hình đúng</li>
                    <li>API Key Firebase không hợp lệ</li>
                    <li>Database bị vô hiệu hóa trong Firebase Console</li>
                </ul>
            </div>
            
            <div class="db-error-actions">
                <button id="retry-connection-btn" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> Thử kết nối lại
                </button>
                <button id="check-firebase-btn" class="btn btn-warning">
                    <i class="fas fa-external-link-alt"></i> Kiểm tra Firebase Console
                </button>
            </div>
            
            <div style="margin-top: 25px; font-size: 0.85rem; color: #666;">
                <p>Nếu vẫn gặp lỗi, vui lòng liên hệ quản trị viên.</p>
            </div>
        </div>
    </div>

    <!-- Authentication Screen -->
    <div id="auth-container" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-header">
                <h2><i class="fas fa-code"></i> CodeRunner</h2>
                <p>Đăng nhập để truy cập hệ thống</p>
            </div>
            
            <div id="login-form" class="auth-form">
                <div id="login-error" class="error-message hidden"></div>
                <div class="form-group">
                    <label for="login-email"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="login-email" placeholder="@gmail.com">
                </div>
                <div class="form-group">
                    <label for="login-password"><i class="fas fa-lock"></i> Mật khẩu</label>
                    <input type="password" id="login-password" placeholder="••••••••">
                </div>
                <button class="btn btn-primary" id="login-btn" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Đăng nhập
                </button>
           
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="main-container hidden">
        <div class="header">
            <div class="logo">
                <i class="fas fa-code"></i>
                <span>CodeRunner Admin</span>
            </div>
            <div class="user-info">
                <div class="user-name" id="admin-name">Admin User</div>
                <div class="user-avatar" id="admin-avatar">A</div>
                <button class="btn btn-danger btn-sm" id="admin-logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </div>
        
        <div class="admin-dashboard">
            <div class="admin-sidebar">
                <div class="admin-sidebar-header">
                    <h3><i class="fas fa-code-branch"></i> Quản lý Code</h3>
                    <button class="btn btn-primary" id="add-code-btn">
                        <i class="fas fa-plus"></i> Thêm code mới
                    </button>
                </div>
                
                <div class="code-list" id="code-list">
                    <!-- Code items will be loaded here -->
                </div>
                
                <div class="admin-sidebar-footer" style="padding: 20px; border-top: 1px solid #eee; background-color: #f8f9fa;">
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 10px; color: var(--text-color);">
                            <i class="fas fa-eye"></i> Code đang hiển thị cho User:
                        </label>
                        <div id="selected-code-display" style="padding: 12px; background-color: white; border-radius: var(--radius-sm); font-size: 0.9rem; border: 1px solid var(--border-color);">
                            <div style="color: var(--text-light);">Chưa có code nào được chọn</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="admin-content">
                <div class="admin-toolbar">
                    <h2><i class="fas fa-edit"></i> <span id="editor-title">Chỉnh sửa Code</span></h2>
                    <div class="admin-toolbar-actions">
                        <button class="btn btn-success" id="save-code-btn">
                            <i class="fas fa-save"></i> Lưu thay đổi
                        </button>
                        <button class="btn btn-warning" id="set-as-user-code-btn">
                            <i class="fas fa-eye"></i> Chọn hiển thị cho User
                        </button>
                        <button class="btn btn-danger" id="delete-code-btn">
                            <i class="fas fa-trash"></i> Xóa code này
                        </button>
                    </div>
                </div>
                
                <div class="editor-container">
                    <div class="code-editor-section">
                        <div class="editor-header">
                            <h3><i class="fas fa-code"></i> Editor</h3>
                            <div class="editor-actions">
                                <select id="language-selector" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-weight: 500;">
                                    <option value="html">HTML</option>
                                    <option value="css">CSS</option>
                                    <option value="javascript">JavaScript</option>
                                </select>
                            </div>
                        </div>
                        <textarea id="code-editor" placeholder="Nhập code của bạn ở đây..."></textarea>
                    </div>
                    
                    <div class="resize-handle" id="resize-handle"></div>
                    
                    <div class="preview-section">
                        <div class="preview-header">
                            <h3><i class="fas fa-eye"></i> Kết quả Preview</h3>
                            <button class="btn btn-primary btn-sm" id="refresh-preview-btn">
                                <i class="fas fa-sync-alt"></i> Làm mới
                            </button>
                        </div>
                        <div class="preview-content">
                            <iframe id="preview-frame"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User View - FULL SCREEN -->
    <div id="user-view" class="user-view hidden">
        <div class="user-view-content">
            <!-- Mini controls (floating) -->
            <div class="user-mini-controls">
                <div class="user-info-mini">
                    <div class="user-avatar-mini" id="user-avatar-mini">U</div>
                    <span id="user-name-mini">User</span>
                </div>
                <button class="btn btn-danger btn-sm" id="user-logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
            
            <!-- Code info overlay -->
            <div class="code-info-overlay">
                <h4 id="current-code-title">Đang tải code...</h4>
                <p id="code-description">Code này anh thay lời muốn nói của anh á em yêu</p>
                <p id="code-update-time" style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;"></p>
            </div>
            
            <!-- Exit fullscreen button -->
            <button class="fullscreen-exit-btn" id="exit-fullscreen-btn" title="Thoát chế độ xem">
                <i class="fas fa-compress"></i>
            </button>
            
            <!-- Fullscreen iframe -->
            <div class="user-preview-container">
                <div class="user-preview-frame-container">
                    <iframe id="user-preview-frame"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Code Modal -->
    <div id="code-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"><i class="fas fa-plus-circle"></i> Thêm code mới</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="code-title"><i class="fas fa-heading"></i> Tiêu đề</label>
                    <input type="text" id="code-title" placeholder="Nhập tiêu đề code">
                </div>
                <div class="form-group">
                    <label for="modal-language-selector"><i class="fas fa-language"></i> Ngôn ngữ</label>
                    <select id="modal-language-selector">
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="javascript">JavaScript</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="code-description-input"><i class="fas fa-align-left"></i> Mô tả (tùy chọn)</label>
                    <input type="text" id="code-description-input" placeholder="Mô tả ngắn về code">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-modal-btn">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button class="btn btn-primary" id="save-modal-btn">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase và Application Logic -->
    <script>
        // ========== FIREBASE CONFIGURATION ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCibFrVhSBB-jzZa-af8joC4PyMBPUyabU",
            authDomain: "chathub-46d8f.firebaseapp.com",
            databaseURL: "https://chathub-46d8f-default-rtdb.firebaseio.com",
            projectId: "chathub-46d8f",
            storageBucket: "chathub-46d8f.appspot.com",
            messagingSenderId: "269084298645",
            appId: "1:269084298645:web:d64abd09aeac50d73e7a9c",
            measurementId: "G-D3Q0GELQ30"
        };

        // Application state
        let app, database;
        let currentUser = null;
        let currentCode = null;
        let codes = [];
        let dbErrorCount = 0;
        const MAX_DB_ERROR_RETRIES = 3;

        // ========== FIREBASE API ==========
        class FirebaseAPI {
            constructor() {
                this.database = null;
                this.listeners = [];
                this.isConnected = false;
                
                // Initialize references
                this.usersRef = null;
                this.codesRef = null;
                this.selectedCodeRef = null;
                
                // Initialize Firebase
                this.initializeFirebase();
            }
            
            initializeFirebase() {
                try {
                    // Check if Firebase is already initialized
                    if (!firebase.apps.length) {
                        app = firebase.initializeApp(firebaseConfig);
                    } else {
                        app = firebase.app();
                    }
                    
                    database = firebase.database();
                    this.database = database;
                    
                    // Initialize references
                    this.usersRef = this.database.ref('users');
                    this.codesRef = this.database.ref('codes');
                    this.selectedCodeRef = this.database.ref('selectedCode');
                    
                    console.log("Firebase initialized successfully");
                    this.isConnected = true;
                    
                    // Set up connection state listener
                    this.setupConnectionListener();
                    
                    return true;
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    this.isConnected = false;
                    showDatabaseError(error.message);
                    return false;
                }
            }
            
            setupConnectionListener() {
                // Listen for connection state changes
                const connectedRef = this.database.ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    if (snap.val() === true) {
                        this.isConnected = true;
                        hideDatabaseError();
                        console.log("Connected to Firebase Database");
                    } else {
                        this.isConnected = false;
                        console.log("Disconnected from Firebase Database");
                    }
                });
                
                // Listen for database errors
                this.codesRef.on("value", () => {}, (error) => {
                    console.error("Firebase database error:", error);
                    this.isConnected = false;
                    showDatabaseError(error.message);
                });
            }
            
            // User methods
            async login(email, password) {
                if (!this.isConnected || !this.usersRef) {
                    return { 
                        success: false, 
                        message: 'Không thể kết nối đến database. Vui lòng kiểm tra kết nối Internet.' 
                    };
                }
                
                try {
                    const snapshot = await this.usersRef.once('value');
                    const users = snapshot.val();
                    
                    if (!users) {
                        // Create default users
                        const defaultUsers = [
                            {
                                id: 'admin_1',
                                name: 'Admin User',
                                email: 'admin@example.com',
                                password: 'admin123',
                                role: 'admin',
                                avatar: 'A',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: 'user_1',
                                name: 'Regular User',
                                email: 'user@example.com',
                                password: 'user123',
                                role: 'user',
                                avatar: 'U',
                                createdAt: new Date().toISOString()
                            }
                        ];
                        
                        for (const user of defaultUsers) {
                            await this.usersRef.child(user.id).set(user);
                        }
                        
                        // Retry login after creating users
                        return this.login(email, password);
                    }
                    
                    // Find user
                    const user = Object.values(users).find(u => u.email === email && u.password === password);
                    
                    if (user) {
                        return {
                            success: true,
                            user: {
                                id: user.id,
                                name: user.name,
                                email: user.email,
                                role: user.role,
                                avatar: user.avatar
                            }
                        };
                    } else {
                        return {
                            success: false,
                            message: 'Email hoặc mật khẩu không đúng'
                        };
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    return { 
                        success: false, 
                        message: 'Lỗi kết nối đến server: ' + (error.message || 'Unknown error') 
                    };
                }
            }
            
            // Code methods
            async getCodes() {
                if (!this.isConnected) {
                    showDatabaseError("Mất kết nối database");
                    return [];
                }
                
                try {
                    const codesSnapshot = await this.codesRef.once('value');
                    const selectedCodeSnapshot = await this.selectedCodeRef.once('value');
                    const selectedCodeId = selectedCodeSnapshot.val();
                    
                    const codes = codesSnapshot.val();
                    if (!codes) {
                        // Create default code if none exists
                        await this.createDefaultCode();
                        return this.getCodes();
                    }
                    
                    // Convert to array and mark selected code
                    return Object.values(codes).map(code => ({
                        ...code,
                        selected: code.id === selectedCodeId
                    }));
                } catch (error) {
                    console.error("Get codes error:", error);
                    showDatabaseError("Lỗi khi tải code: " + error.message);
                    return [];
                }
            }
            
            async createDefaultCode() {
                try {
                    const defaultCode = {
                        id: 'code_1',
                        title: 'Trang chào mừng',
                        description: 'Trang chào mừng đơn giản',
                        language: 'html',
                        content: `<!DOCTYPE html>
<html>
<head>
    <title>Chào mừng đến với CodeRunner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            text-align: center;
            padding: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .highlight {
            color: #ffcc00;
            font-weight: bold;
        }
        
        p {
            font-size: 1.3rem;
            line-height: 1.7;
            margin-bottom: 30px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .time-display {
            font-size: 1.5rem;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px 25px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .features {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 40px;
        }
        
        .feature {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 10px;
            width: 200px;
            transition: transform 0.3s;
        }
        
        .feature:hover {
            transform: translateY(-5px);
        }
        
        .feature i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #ffcc00;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            p {
                font-size: 1.1rem;
            }
            
            .container {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chào mừng đến với <span class="highlight">CodeRunner</span></h1>
        <p>Hệ thống quản lý code với tính năng Admin và User. Code này đang được hiển thị cho tất cả người dùng.</p>
        
        <div class="time-display">
            Thời gian hiện tại: <span id="time">00:00:00</span>
        </div>
        
        <div class="features">
            <div class="feature">
                <i class="fas fa-code"></i>
                <h3>Code HTML/CSS/JS</h3>
                <p>Hỗ trợ đa ngôn ngữ</p>
            </div>
            <div class="feature">
                <i class="fas fa-user-shield"></i>
                <h3>Phân quyền</h3>
                <p>Admin & User riêng biệt</p>
            </div>
            <div class="feature">
                <i class="fas fa-sync-alt"></i>
                <h3>Cập nhật real-time</h3>
                <p>Thay đổi ngay lập tức</p>
            </div>
        </div>
    </div>
    
    <script>
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById('time').textContent = timeStr;
        }
        updateTime();
        setInterval(updateTime, 1000);
    <\/script>
</body>
</html>`,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdBy: 'admin_1'
                    };
                    
                    await this.codesRef.child(defaultCode.id).set(defaultCode);
                    await this.selectedCodeRef.set(defaultCode.id);
                    
                    return defaultCode;
                } catch (error) {
                    console.error("Error creating default code:", error);
                    throw error;
                }
            }
            
            async getCodeById(id) {
                if (!this.isConnected) {
                    showDatabaseError("Mất kết nối database");
                    return null;
                }
                
                try {
                    const snapshot = await this.codesRef.child(id).once('value');
                    return snapshot.val();
                } catch (error) {
                    console.error("Get code by id error:", error);
                    return null;
                }
            }
            
            async createCode(codeData) {
                if (!this.isConnected) {
                    throw new Error('Không thể kết nối đến database. Vui lòng kiểm tra kết nối Internet.');
                }
                
                try {
                    const newCodeId = 'code_' + Date.now();
                    const newCode = {
                        ...codeData,
                        id: newCodeId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    await this.codesRef.child(newCodeId).set(newCode);
                    
                    // Notify listeners
                    this.notifyListeners('codesUpdated', await this.getCodes());
                    return newCode;
                } catch (error) {
                    console.error("Create code error:", error);
                    throw new Error('Lỗi khi tạo code: ' + error.message);
                }
            }
            
            async updateCode(id, codeData) {
                if (!this.isConnected) {
                    throw new Error('Không thể kết nối đến database. Vui lòng kiểm tra kết nối Internet.');
                }
                
                try {
                    const codeRef = this.codesRef.child(id);
                    const snapshot = await codeRef.once('value');
                    
                    if (!snapshot.exists()) {
                        throw new Error('Code không tồn tại');
                    }
                    
                    const updatedCode = {
                        ...snapshot.val(),
                        ...codeData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    await codeRef.update(updatedCode);
                    
                    // Notify listeners
                    this.notifyListeners('codesUpdated', await this.getCodes());
                    this.notifyListeners('codeUpdated', { id, ...updatedCode });
                    return updatedCode;
                } catch (error) {
                    console.error("Update code error:", error);
                    throw new Error('Lỗi khi cập nhật code: ' + error.message);
                }
            }
            
            async deleteCode(id) {
                if (!this.isConnected) {
                    throw new Error('Không thể kết nối đến database. Vui lòng kiểm tra kết nối Internet.');
                }
                
                try {
                    // Check if this code is selected
                    const selectedCodeSnapshot = await this.selectedCodeRef.once('value');
                    const selectedCodeId = selectedCodeSnapshot.val();
                    
                    if (selectedCodeId === id) {
                        // If deleting selected code, clear selection
                        await this.selectedCodeRef.remove();
                        this.notifyListeners('selectedCodeUpdated', null);
                    }
                    
                    // Delete the code
                    await this.codesRef.child(id).remove();
                    
                    // Notify listeners
                    this.notifyListeners('codesUpdated', await this.getCodes());
                    return true;
                } catch (error) {
                    console.error("Delete code error:", error);
                    throw new Error('Lỗi khi xóa code: ' + error.message);
                }
            }
            
            async setSelectedCode(id) {
                if (!this.isConnected) {
                    throw new Error('Không thể kết nối đến database. Vui lòng kiểm tra kết nối Internet.');
                }
                
                try {
                    // First check if code exists
                    const codeSnapshot = await this.codesRef.child(id).once('value');
                    if (!codeSnapshot.exists()) {
                        throw new Error('Code không tồn tại');
                    }
                    
                    await this.selectedCodeRef.set(id);
                    this.notifyListeners('selectedCodeUpdated', id);
                    return true;
                } catch (error) {
                    console.error("Set selected code error:", error);
                    throw new Error('Lỗi khi chọn code hiển thị: ' + error.message);
                }
            }
            
            async getSelectedCode() {
                if (!this.isConnected) {
                    showDatabaseError("Mất kết nối database");
                    return null;
                }
                
                try {
                    const selectedCodeSnapshot = await this.selectedCodeRef.once('value');
                    const selectedCodeId = selectedCodeSnapshot.val();
                    
                    if (!selectedCodeId) return null;
                    
                    return this.getCodeById(selectedCodeId);
                } catch (error) {
                    console.error("Get selected code error:", error);
                    return null;
                }
            }
            
            // Real-time listeners
            addListener(event, callback) {
                this.listeners.push({ event, callback });
                
                // Set up Firebase real-time listeners if connected
                if (this.isConnected) {
                    if (event === 'codesUpdated') {
                        this.codesRef.on('value', async (snapshot) => {
                            try {
                                const selectedCodeSnapshot = await this.selectedCodeRef.once('value');
                                const selectedCodeId = selectedCodeSnapshot.val();
                                const codes = snapshot.val();
                                
                                if (!codes) {
                                    callback([]);
                                    return;
                                }
                                
                                const codesArray = Object.values(codes).map(code => ({
                                    ...code,
                                    selected: code.id === selectedCodeId
                                }));
                                
                                callback(codesArray);
                            } catch (error) {
                                console.error("Real-time codes update error:", error);
                            }
                        }, (error) => {
                            console.error("Real-time codes listener error:", error);
                        });
                    } else if (event === 'selectedCodeUpdated') {
                        this.selectedCodeRef.on('value', (snapshot) => {
                            callback(snapshot.val());
                        }, (error) => {
                            console.error("Real-time selected code listener error:", error);
                        });
                    } else if (event === 'codeUpdated') {
                        // Listen for updates to individual codes
                        this.codesRef.on('child_changed', (snapshot) => {
                            callback(snapshot.val());
                        }, (error) => {
                            console.error("Real-time code update listener error:", error);
                        });
                    }
                }
            }
            
            notifyListeners(event, data) {
                this.listeners.forEach(listener => {
                    if (listener.event === event) {
                        listener.callback(data);
                    }
                });
            }
            
            // Check connection
            checkConnection() {
                return this.isConnected;
            }
            
            // Reconnect
            async reconnect() {
                try {
                    this.initializeFirebase();
                    return this.isConnected;
                } catch (error) {
                    console.error("Reconnection failed:", error);
                    return false;
                }
            }
        
        
        
        
        
        }

        // ========== APPLICATION LOGIC ==========
        let api = null;

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const adminDashboard = document.getElementById('admin-dashboard');
        const userView = document.getElementById('user-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginBtn = document.getElementById('login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const userLogoutBtn = document.getElementById('user-logout-btn');
        const codeList = document.getElementById('code-list');
        const codeEditor = document.getElementById('code-editor');
        const previewFrame = document.getElementById('preview-frame');
        const userPreviewFrame = document.getElementById('user-preview-frame');
        const addCodeBtn = document.getElementById('add-code-btn');
        const saveCodeBtn = document.getElementById('save-code-btn');
        const deleteCodeBtn = document.getElementById('delete-code-btn');
        const setAsUserCodeBtn = document.getElementById('set-as-user-code-btn');
        const refreshPreviewBtn = document.getElementById('refresh-preview-btn');
        const languageSelector = document.getElementById('language-selector');
        const editorTitle = document.getElementById('editor-title');
        const selectedCodeDisplay = document.getElementById('selected-code-display');
        const codeModal = document.getElementById('code-modal');
        const modalTitle = document.getElementById('modal-title');
        const codeTitleInput = document.getElementById('code-title');
        const modalLanguageSelector = document.getElementById('modal-language-selector');
        const codeDescriptionInput = document.getElementById('code-description-input');
        const saveModalBtn = document.getElementById('save-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const resizeHandle = document.getElementById('resize-handle');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const dbErrorModal = document.getElementById('db-error-modal');
        const retryConnectionBtn = document.getElementById('retry-connection-btn');
        const checkFirebaseBtn = document.getElementById('check-firebase-btn');
        const currentCodeTitle = document.getElementById('current-code-title');
        const codeUpdateTime = document.getElementById('code-update-time');
        const userLogoutBtnMini = document.getElementById('user-logout-btn-mini');
        const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');
        const userAvatarMini = document.getElementById('user-avatar-mini');
        const userNameMini = document.getElementById('user-name-mini');
        
        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="flex: 1;">
                    <strong>${type === 'success' ? 'Thành công!' : type === 'error' ? 'Lỗi!' : 'Thông báo'}</strong>
                    <p style="margin-top: 5px; font-size: 0.9rem;">${message}</p>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            // Close button
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
            });
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Database error handling
        function showDatabaseError(errorMessage = "") {
            dbErrorCount++;
            
            // Only show modal if we've had multiple errors
            if (dbErrorCount >= MAX_DB_ERROR_RETRIES) {
                dbErrorModal.classList.remove('hidden');
                
                // Update error message if provided
                if (errorMessage) {
                    const errorDetails = dbErrorModal.querySelector('.offline-mode p');
                    if (errorDetails) {
                        errorDetails.innerHTML = `Không thể kết nối đến Firebase Database. Chi tiết lỗi: <strong>${errorMessage}</strong>`;
                    }
                }
            }
        }
        
        function hideDatabaseError() {
            dbErrorCount = 0;
            dbErrorModal.classList.add('hidden');
        }
        
        // Initialize
        async function init() {
            // Show loading
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Đang khởi tạo Firebase...';
            
            // Initialize Firebase API
            api = new FirebaseAPI();
            
            // Wait a moment for Firebase to initialize
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Check connection
            if (!api.checkConnection()) {
                loadingText.textContent = 'Đang thử kết nối lại...';
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (!api.checkConnection()) {
                    loadingOverlay.classList.add('hidden');
                    showDatabaseError("Không thể kết nối đến Firebase Database");
                    return;
                }
            }
            
            // Hide loading
            loadingOverlay.classList.add('hidden');
            
            // Show auth container
            authContainer.classList.remove('hidden');
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('coderunner_current_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showAppropriateView();
                    loadData();
                } catch (e) {
                    console.error('Error loading saved user:', e);
                    localStorage.removeItem('coderunner_current_user');
                }
            }
            
            // Add event listeners
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // Auth events
            loginBtn.addEventListener('click', handleLogin);
            adminLogoutBtn.addEventListener('click', handleLogout);
            userLogoutBtn.addEventListener('click', handleLogout);
            
            // User mini controls events
            if (userLogoutBtnMini) {
                userLogoutBtnMini.addEventListener('click', handleLogout);
            }
            if (exitFullscreenBtn) {
                exitFullscreenBtn.addEventListener('click', exitFullscreenView);
            }
            
            // Database error events
            retryConnectionBtn.addEventListener('click', handleRetryConnection);
            checkFirebaseBtn.addEventListener('click', () => {
                window.open('https://console.firebase.google.com/u/0/project/chathub-46d8f/database/chathub-46d8f-default-rtdb/data', '_blank');
            });
            
            // Admin events
            addCodeBtn.addEventListener('click', showAddCodeModal);
            saveCodeBtn.addEventListener('click', saveCurrentCode);
            deleteCodeBtn.addEventListener('click', deleteCurrentCode);
            setAsUserCodeBtn.addEventListener('click', setAsUserCode);
            refreshPreviewBtn.addEventListener('click', refreshPreview);
            languageSelector.addEventListener('change', updatePreview);
            codeEditor.addEventListener('input', updatePreview);
            saveModalBtn.addEventListener('click', handleSaveModal);
            cancelModalBtn.addEventListener('click', hideModal);
            
            // Setup resize handle
            setupResizable();
            
            // Listen for real-time updates
            if (api) {
                api.addListener('codesUpdated', handleCodesUpdated);
                api.addListener('selectedCodeUpdated', handleSelectedCodeUpdated);
                api.addListener('codeUpdated', handleCodeUpdated);
            }
        }
        
        function exitFullscreenView() {
            handleLogout();
        }
        
        // Handle retry connection
        async function handleRetryConnection() {
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Đang thử kết nối lại...';
            
            if (api) {
                const reconnected = await api.reconnect();
                
                if (reconnected) {
                    hideDatabaseError();
                    showNotification('Đã kết nối lại Firebase thành công!', 'success');
                    
                    // Reload data if user is logged in
                    if (currentUser) {
                        loadData();
                    }
                } else {
                    showDatabaseError("Vẫn không thể kết nối đến Firebase");
                }
            }
            
            loadingOverlay.classList.add('hidden');
        }
        
        // Login handler
        async function handleLogin() {
            if (!api || !api.checkConnection()) {
                showDatabaseError("Không thể kết nối đến database");
                return;
            }
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showError(loginError, 'Vui lòng nhập email và mật khẩu');
                return;
            }
            
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Đang đăng nhập...';
            
            const result = await api.login(email, password);
            
            loadingOverlay.classList.add('hidden');
            
            if (result.success) {
                currentUser = result.user;
                localStorage.setItem('coderunner_current_user', JSON.stringify(currentUser));
                showAppropriateView();
                loadData();
                showNotification('Đăng nhập thành công!', 'success');
            } else {
                showError(loginError, result.message);
            }
        }
        
        // Logout handler
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('coderunner_current_user');
            authContainer.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
            userView.classList.add('hidden');
            
            // Khôi phục overflow
            document.body.style.overflow = '';
            
            // Clear form
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            loginError.classList.add('hidden');
            
            showNotification('Đã đăng xuất thành công!', 'info');
        }
        
        // Show appropriate view based on user role
        function showAppropriateView() {
            authContainer.classList.add('hidden');
            
            if (currentUser.role === 'admin') {
                adminDashboard.classList.remove('hidden');
                userView.classList.add('hidden');
                
                // Update admin UI
                document.getElementById('admin-name').textContent = currentUser.name;
                document.getElementById('admin-avatar').textContent = currentUser.avatar;
            } else {
                adminDashboard.classList.add('hidden');
                userView.classList.remove('hidden');
                
                // Update mini user UI
                if (userNameMini) userNameMini.textContent = currentUser.name;
                if (userAvatarMini) userAvatarMini.textContent = currentUser.avatar;
                
                // Enter fullscreen mode for user
                enterFullscreenMode();
            }
        }
        
        function enterFullscreenMode() {
            // Ẩn thanh cuộn
            document.body.style.overflow = 'hidden';
            
            // Tự động ẩn các overlay sau 5 giây
            setTimeout(() => {
                const miniControls = document.querySelector('.user-mini-controls');
                const codeInfo = document.querySelector('.code-info-overlay');
                const exitBtn = document.querySelector('.fullscreen-exit-btn');
                
                if (miniControls) miniControls.style.opacity = '0.3';
                if (codeInfo) codeInfo.style.opacity = '0.3';
                if (exitBtn) exitBtn.style.opacity = '0.3';
            }, 5000);
            
            // Hiển thị lại khi hover
            const containers = ['.user-mini-controls', '.code-info-overlay', '.fullscreen-exit-btn'];
            containers.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    element.addEventListener('mouseenter', () => {
                        element.style.opacity = '1';
                    });
                    element.addEventListener('mouseleave', () => {
                        element.style.opacity = '0.3';
                    });
                }
            });
        }
        
        // Load data
        async function loadData() {
            if (!api || !api.checkConnection()) {
                showDatabaseError("Không thể kết nối đến database");
                return;
            }
            
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Đang tải dữ liệu...';
            
            try {
                if (currentUser.role === 'admin') {
                    await loadCodes();
                    await loadSelectedCodeInfo();
                } else {
                    await loadUserCode();
                }
            } catch (error) {
                console.error("Load data error:", error);
                showDatabaseError(error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // Load codes for admin
        async function loadCodes() {
            codes = await api.getCodes();
            renderCodeList();
            
            // Select first code if none selected and codes exist
            if (codes.length > 0 && !currentCode) {
                const selectedCode = codes.find(code => code.selected) || codes[0];
                selectCode(selectedCode);
            } else if (codes.length === 0) {
                // No codes, clear editor
                currentCode = null;
                codeEditor.value = '';
                editorTitle.textContent = 'Chỉnh sửa Code';
                deleteCodeBtn.disabled = true;
                setAsUserCodeBtn.disabled = true;
                saveCodeBtn.disabled = true;
            } else {
                // Enable save button if we have a code selected
                saveCodeBtn.disabled = false;
            }
        }
        
        // Render code list
        function renderCodeList() {
            if (codes.length === 0) {
                codeList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-code"></i>
                        <p>Chưa có code nào. Hãy thêm code mới!</p>
                    </div>
                `;
                return;
            }
            
            codeList.innerHTML = codes.map(code => `
                <div class="code-item ${code.id === currentCode?.id ? 'selected' : ''}" data-id="${code.id}">
                    <div class="code-item-header">
                        <div class="code-item-title">
                            ${code.title}
                            ${code.selected ? '<span class="badge badge-success">Đang hiển thị</span>' : ''}
                        </div>
                        <div class="code-item-actions">
                            ${code.selected ? '<i class="fas fa-eye" style="color: var(--success-color);" title="Đang hiển thị cho User"></i>' : ''}
                        </div>
                    </div>
                    <div class="code-item-language ${code.language}">${code.language.toUpperCase()}</div>
                    <div class="code-item-date">
                        <i class="far fa-clock"></i>
                        Cập nhật: ${new Date(code.updatedAt).toLocaleDateString('vi-VN')}
                    </div>
                </div>
            `).join('');
            
            // Add click event listeners to code items
            document.querySelectorAll('.code-item').forEach(item => {
                item.addEventListener('click', () => {
                    const codeId = item.getAttribute('data-id');
                    const code = codes.find(c => c.id === codeId);
                    if (code) {
                        selectCode(code);
                    }
                });
            });
        }
        
        // Select a code
        async function selectCode(code) {
            currentCode = code;
            
            // Update UI
            editorTitle.textContent = `Chỉnh sửa: ${code.title}`;
            codeEditor.value = code.content;
            languageSelector.value = code.language;
            
            // Update preview
            updatePreview();
            
            // Update code list selection
            document.querySelectorAll('.code-item').forEach(item => {
                item.classList.toggle('selected', item.getAttribute('data-id') === code.id);
            });
            
            // Enable buttons
            saveCodeBtn.disabled = false;
            
            // Show delete button only if not selected for users
            deleteCodeBtn.disabled = code.selected;
            setAsUserCodeBtn.disabled = code.selected;
            
            // If this code is selected for users, update the button text
            if (code.selected) {
                setAsUserCodeBtn.innerHTML = '<i class="fas fa-check"></i> Đang hiển thị cho User';
                setAsUserCodeBtn.classList.add('btn-success');
                setAsUserCodeBtn.classList.remove('btn-warning');
                deleteCodeBtn.disabled = true;
            } else {
                setAsUserCodeBtn.innerHTML = '<i class="fas fa-eye"></i> Chọn hiển thị cho User';
                setAsUserCodeBtn.classList.add('btn-warning');
                setAsUserCodeBtn.classList.remove('btn-success');
                deleteCodeBtn.disabled = false;
            }
        }
        
        // Load selected code info
        async function loadSelectedCodeInfo() {
            const selectedCode = await api.getSelectedCode();
            if (selectedCode) {
                selectedCodeDisplay.innerHTML = `
                    <div style="font-weight: 600; color: var(--primary-color);">${selectedCode.title}</div>
                    <div style="margin-top: 5px; font-size: 0.85rem; color: var(--text-light);">
                        ${selectedCode.description || 'Không có mô tả'}
                    </div>
                    <div style="margin-top: 5px; font-size: 0.8rem; color: #999;">
                        <i class="far fa-clock"></i> Cập nhật: ${new Date(selectedCode.updatedAt).toLocaleDateString('vi-VN')}
                    </div>
                `;
            } else {
                selectedCodeDisplay.innerHTML = `
                    <div style="color: var(--text-light); font-style: italic;">
                        <i class="fas fa-exclamation-circle"></i> Chưa có code nào được chọn
                    </div>
                `;
            }
        }
        
        // Load user code
        async function loadUserCode() {
            const selectedCode = await api.getSelectedCode();
            if (selectedCode) {
                // Cập nhật thông tin overlay
                currentCodeTitle.textContent = selectedCode.title;
                document.getElementById('code-description').textContent = selectedCode.description || 'Code này anh thay lời muốn nói của anh á em yêu';
                codeUpdateTime.textContent = `Cập nhật: ${new Date(selectedCode.updatedAt).toLocaleString('vi-VN')}`;
                
                // Cập nhật thông tin user mini
                if (currentUser && userNameMini && userAvatarMini) {
                    userNameMini.textContent = currentUser.name;
                    userAvatarMini.textContent = currentUser.avatar;
                }
                
                // Render code fullscreen
                renderCodeInIframe(userPreviewFrame, selectedCode.content);
            } else {
                // Hiển thị màn hình không có code
                currentCodeTitle.textContent = 'Không có code nào';
                document.getElementById('code-description').textContent = 'Admin chưa chọn code để hiển thị';
                codeUpdateTime.textContent = '';
                
                renderCodeInIframe(userPreviewFrame, `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                                font-family: 'Segoe UI', sans-serif;
                            }
                            
                            body {
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                height: 100vh;
                                background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
                                color: #fff;
                                padding: 20px;
                            }
                            
                            .container {
                                text-align: center;
                                padding: 40px;
                                background-color: rgba(255, 255, 255, 0.05);
                                border-radius: 15px;
                                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                                max-width: 600px;
                                width: 100%;
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                backdrop-filter: blur(10px);
                            }
                            
                            h1 {
                                color: #ff6b6b;
                                margin-bottom: 20px;
                                font-size: 2.5rem;
                            }
                            
                            p {
                                font-size: 1.2rem;
                                line-height: 1.6;
                                margin-bottom: 30px;
                                color: #ccc;
                            }
                            
                            .icon {
                                font-size: 4rem;
                                color: #4dabf7;
                                margin-bottom: 20px;
                            }
                            
                            .highlight {
                                color: #ffcc00;
                                font-weight: bold;
                            }
                            
                            .loading {
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                border: 3px solid rgba(255, 255, 255, 0.3);
                                border-top-color: #4dabf7;
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin-left: 10px;
                            }
                            
                            @keyframes spin {
                                to { transform: rotate(360deg); }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="icon">👨‍💻</div>
                            <h1>Đang chờ code...</h1>
                            <p>Quản trị viên chưa chọn code nào để hiển thị.</p>
                            <p>Vui lòng chờ trong giây lát <span class="loading"></span></p>
                            <p>Hoặc liên hệ với <span class="highlight">quản trị viên</span> để biết thêm thông tin.</p>
                        </div>
                    </body>
                    </html>
                `);
            }
        }
        
        // Update preview
        function updatePreview() {
            if (!currentCode) return;
            
            const code = codeEditor.value;
            const language = languageSelector.value;
            
            // Update current code object
            currentCode.content = code;
            currentCode.language = language;
            
            // Render in iframe
            renderCodeInIframe(previewFrame, code);
        }
        
        // Refresh preview
        function refreshPreview() {
            updatePreview();
            showNotification('Đã làm mới preview', 'info');
        }
        
        // Render code in iframe
        function renderCodeInIframe(iframe, code) {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            
            // Wrap code in HTML if it's not already
            if (languageSelector.value === 'html' || !languageSelector.value) {
                iframeDoc.write(code);
            } else if (languageSelector.value === 'css') {
                iframeDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>${code}</style>
                    </head>
                    <body>
                        <div style="padding: 30px; font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white;">
                            <h1 style="color: white; margin-bottom: 20px;">CSS Preview</h1>
                            <div class="demo-box" style="padding: 20px; background-color: rgba(255, 255, 255, 0.1); border-radius: 8px; margin-bottom: 20px; backdrop-filter: blur(10px);">
                                Đây là hộp demo với CSS của bạn
                            </div>
                            <button class="demo-btn" style="padding: 12px 24px; background-color: white; color: #667eea; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;">
                                Nút demo
                            </button>
                        </div>
                    </body>
                    </html>
                `);
            } else if (languageSelector.value === 'javascript') {
                iframeDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>JavaScript Preview</title>
                        <style>
                            body {
                                font-family: 'Segoe UI', sans-serif;
                                padding: 30px;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                min-height: 100vh;
                                color: white;
                            }
                            h1 {
                                color: white;
                                margin-bottom: 20px;
                            }
                            #output {
                                padding: 20px;
                                background-color: rgba(255, 255, 255, 0.1);
                                border-radius: 8px;
                                min-height: 100px;
                                border: 1px solid rgba(255, 255, 255, 0.2);
                                backdrop-filter: blur(10px);
                                margin-bottom: 20px;
                            }
                            button {
                                padding: 12px 24px;
                                background-color: white;
                                color: #667eea;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: 600;
                                transition: all 0.3s;
                            }
                            button:hover {
                                transform: translateY(-2px);
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                            }
                        </style>
                    </head>
                    <body>
                        <h1>JavaScript Preview</h1>
                        <div id="output">Kết quả sẽ hiển thị ở đây</div>
                        <button onclick="runDemo()">Chạy Demo</button>
                        <script>
                            function runDemo() {
                                document.getElementById('output').innerHTML = '<h3>JavaScript đang chạy!</h3><p>Code JS của bạn đã được thực thi thành công.</p>';
                            }
                            ${code}
                        <\/script>
                    </body>
                    </html>
                `);
            }
            
            iframeDoc.close();
        }
        
        // Show add code modal
        function showAddCodeModal() {
            modalTitle.textContent = 'Thêm code mới';
            codeTitleInput.value = '';
            modalLanguageSelector.value = 'html';
            codeDescriptionInput.value = '';
            codeModal.classList.remove('hidden');
            
            // Set focus
            setTimeout(() => {
                codeTitleInput.focus();
            }, 100);
        }
        
        // Hide modal
        function hideModal() {
            codeModal.classList.add('hidden');
        }
        
        // Handle save modal
        async function handleSaveModal() {
            const title = codeTitleInput.value.trim();
            const language = modalLanguageSelector.value;
            const description = codeDescriptionInput.value.trim();
            
            if (!title) {
                showNotification('Vui lòng nhập tiêu đề code', 'error');
                return;
            }
            
            const codeData = {
                title,
                language,
                description,
                content: `<!DOCTYPE html>
<html>
<head>
    <title>${title}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            text-align: center;
            padding: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            color: white;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        p {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .highlight {
            color: #ffcc00;
            font-weight: bold;
        }
        
        .btn {
            padding: 12px 24px;
            background-color: white;
            color: #667eea;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>${title}</h1>
        <p>Code mới được tạo bởi Admin. Hãy chỉnh sửa nội dung ở đây.</p>
        <p>Thời gian tạo: <span class="highlight" id="current-time"></span></p>
        <button class="btn" onclick="alert('Code mới được tạo thành công!')">Xác nhận</button>
    </div>
    
    <script>
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('vi-VN');
        }
        updateTime();
        setInterval(updateTime, 1000);
    <\/script>
</body>
</html>`,
                createdBy: currentUser.id
            };
            
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Đang lưu code...';
            
            try {
                const newCode = await api.createCode(codeData);
                hideModal();
                
                // Select the new code
                codes = await api.getCodes();
                renderCodeList();
                selectCode(newCode);
                
                showNotification(`Đã tạo code "${title}" thành công!`, 'success');
            } catch (error) {
                showNotification('Lỗi khi tạo code: ' + error.message, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // Save current code
        async function saveCurrentCode() {
            if (!currentCode) {
                showNotification('Không có code nào được chọn để lưu', 'error');
                return;
            }
            
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Đang lưu thay đổi...';
            
            try {
                const updatedCode = await api.updateCode(currentCode.id, {
                    title: currentCode.title,
                    content: codeEditor.value,
                    language: languageSelector.value,
                    description: currentCode.description
                });
                
                if (updatedCode) {
                    currentCode = updatedCode;
                    showNotification('Đã lưu code thành công!', 'success');
                    
                    // Update code list
                    codes = await api.getCodes();
                    renderCodeList();
                    
                    // If this code is selected for users, update user view
                    if (currentCode.selected) {
                        await updateUserView(currentCode);
                    }
                    
                    // Update selected code info
                    await loadSelectedCodeInfo();
                } else {
                    showNotification('Lỗi khi lưu code', 'error');
                }
            } catch (error) {
                showNotification('Lỗi khi lưu code: ' + error.message, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // Delete current code
        async function deleteCurrentCode() {
            if (!currentCode) {
                showNotification('Không có code nào được chọn để xóa', 'error');
                return;
            }
            
            if (currentCode.selected) {
                showNotification('Không thể xóa code đang được hiển thị cho User', 'error');
                return;
            }
            
            const confirmation = confirm(`Bạn có chắc chắn muốn xóa code "${currentCode.title}"? Hành động này không thể hoàn tác.`);
            
            if (!confirmation) return;
            
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Đang xóa code...';
            
            try {
                // Delete the code
                await api.deleteCode(currentCode.id);
                
                // Show success message
                showNotification(`Đã xóa code "${currentCode.title}" thành công!`, 'success');
                
                // Clear current code
                currentCode = null;
                codeEditor.value = '';
                editorTitle.textContent = 'Chỉnh sửa Code';
                
                // Reload codes
                codes = await api.getCodes();
                renderCodeList();
                
                // Update selected code info
                await loadSelectedCodeInfo();
                
                // Select first code if available
                if (codes.length > 0) {
                    // Wait a moment for the list to render
                    setTimeout(() => {
                        const firstCodeItem = document.querySelector('.code-item');
                        if (firstCodeItem) {
                            const codeId = firstCodeItem.getAttribute('data-id');
                            const code = codes.find(c => c.id === codeId);
                            if (code) {
                                selectCode(code);
                            }
                        }
                    }, 100);
                } else {
                    // No codes left, disable buttons
                    deleteCodeBtn.disabled = true;
                    setAsUserCodeBtn.disabled = true;
                    saveCodeBtn.disabled = true;
                }
                
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Lỗi khi xóa code: ' + error.message, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // Set as user code
        async function setAsUserCode() {
            if (!currentCode) {
                showNotification('Không có code nào được chọn', 'error');
                return;
            }
            
            if (currentCode.selected) {
                showNotification('Code này đã được chọn hiển thị cho User', 'info');
                return;
            }
            
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = 'Đang cập nhật code hiển thị...';
            
            try {
                await api.setSelectedCode(currentCode.id);
                showNotification(`Đã chọn "${currentCode.title}" làm code hiển thị cho User`, 'success');
                
                // Update UI
                await loadSelectedCodeInfo();
                codes = await api.getCodes();
                renderCodeList();
                
                // Update current code from new list and select it
                const updatedCurrentCode = codes.find(code => code.id === currentCode.id);
                if (updatedCurrentCode) {
                    selectCode(updatedCurrentCode);
                }
                
                // Update user view
                await updateUserView(updatedCurrentCode);
                
            } catch (error) {
                console.error('Error setting selected code:', error);
                showNotification('Lỗi khi chọn code hiển thị cho User: ' + error.message, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // Update user view with code
        async function updateUserView(code) {
            if (!code) return;
            
            const selectedCode = await api.getSelectedCode();
            if (selectedCode && selectedCode.id === code.id) {
                currentCodeTitle.textContent = code.title;
                document.getElementById('code-description').textContent = code.description || 'Code được chọn bởi Admin';
                codeUpdateTime.textContent = `Cập nhật: ${new Date(code.updatedAt).toLocaleString('vi-VN')}`;
                renderCodeInIframe(userPreviewFrame, code.content);
            }
        }
        
        // Handle codes updated event
        function handleCodesUpdated(updatedCodes) {
            codes = updatedCodes.map(code => ({
                ...code,
                selected: code.id === currentCode?.id ? currentCode.selected : code.selected
            }));
            
            renderCodeList();
            
            // Update current code if it exists in updated list
            if (currentCode) {
                const updatedCurrentCode = codes.find(c => c.id === currentCode.id);
                if (updatedCurrentCode) {
                    currentCode = updatedCurrentCode;
                    selectCode(currentCode);
                } else {
                    // Current code was deleted
                    currentCode = null;
                    codeEditor.value = '';
                    editorTitle.textContent = 'Chỉnh sửa Code';
                    
                    // Select first code if available
                    if (codes.length > 0) {
                        selectCode(codes[0]);
                    }
                }
            }
        }
        
        // Handle selected code updated event
        async function handleSelectedCodeUpdated(selectedCodeId) {
            // Update code list
            codes = codes.map(code => ({
                ...code,
                selected: code.id === selectedCodeId
            }));
            
            renderCodeList();
            await loadSelectedCodeInfo();
            
            // If user view is active, update it
            if (currentUser && currentUser.role === 'user') {
                await loadUserCode();
            }
            
            // If admin is viewing the selected code, update button
            if (currentCode && currentCode.id === selectedCodeId) {
                setAsUserCodeBtn.innerHTML = '<i class="fas fa-check"></i> Đang hiển thị cho User';
                setAsUserCodeBtn.classList.add('btn-success');
                setAsUserCodeBtn.classList.remove('btn-warning');
                setAsUserCodeBtn.disabled = true;
                deleteCodeBtn.disabled = true;
            } else if (currentCode) {
                setAsUserCodeBtn.innerHTML = '<i class="fas fa-eye"></i> Chọn hiển thị cho User';
                setAsUserCodeBtn.classList.add('btn-warning');
                setAsUserCodeBtn.classList.remove('btn-success');
                setAsUserCodeBtn.disabled = false;
                deleteCodeBtn.disabled = false;
            }
        }
        
        // Handle code updated event
        async function handleCodeUpdated(updatedCode) {
            // Update current code if it's the one that was updated
            if (currentCode && currentCode.id === updatedCode.id) {
                currentCode = updatedCode;
                selectCode(currentCode);
            }
            
            // Update user view if this is the selected code
            const selectedCode = await api.getSelectedCode();
            if (selectedCode && selectedCode.id === updatedCode.id && currentUser && currentUser.role === 'user') {
                await updateUserView(updatedCode);
            }
        }
        
        // Show error
        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }
        
        // Setup resizable editor
        function setupResizable() {
            const editorSection = document.querySelector('.code-editor-section');
            const previewSection = document.querySelector('.preview-section');
            let isResizing = false;
            
            resizeHandle.addEventListener('mousedown', startResize);
            
            function startResize(e) {
                isResizing = true;
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            }
            
            function resize(e) {
                if (!isResizing) return;
                
                const containerRect = document.querySelector('.editor-container').getBoundingClientRect();
                const isVertical = window.innerWidth <= 1024;
                
                if (isVertical) {
                    // Vertical resize (for mobile/tablet)
                    const newHeight = e.clientY - containerRect.top;
                    const containerHeight = containerRect.height;
                    
                    if (newHeight > 100 && newHeight < containerHeight - 100) {
                        editorSection.style.height = `${newHeight}px`;
                        previewSection.style.height = `${containerHeight - newHeight - 8}px`;
                    }
                } else {
                    // Horizontal resize (for desktop)
                    const newWidth = e.clientX - containerRect.left;
                    const containerWidth = containerRect.width;
                    
                    if (newWidth > 200 && newWidth < containerWidth - 200) {
                        editorSection.style.width = `${newWidth}px`;
                        previewSection.style.width = `${containerWidth - newWidth - 8}px`;
                    }
                }
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
